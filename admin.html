<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è½‰ç›¤å¤§æ¨‚é€ï½œç®¡ç†è€…é–‹ç</title>
  <style>
    :root{--bg:#fff7ea;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--brand:#b91c1c;--ok:#16a34a;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px 0;font-size:22px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center;margin:10px 0}
    @media (max-width:560px){.row{grid-template-columns:1fr}}
    label{font-weight:800}
    input, textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;outline:none}
    input:focus, textarea:focus{border-color:#f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.18)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .primary{background:var(--brand);color:#fff}
    .ghost{background:#fff;border:1px solid var(--line)}
    .warn{background:#fff;border:1px solid rgba(220,38,38,.35);color:var(--bad)}
    .msg{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;font-weight:800}
    .msg.ok{display:block;background:rgba(22,163,74,.12);border:1px solid rgba(22,163,74,.25);color:var(--ok)}
    .msg.bad{display:block;background:rgba(220,38,38,.10);border:1px solid rgba(220,38,38,.25);color:var(--bad)}
    .muted{color:var(--muted);font-size:13px;line-height:1.5}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 8px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top}
    th{background:#f9fafb;position:sticky;top:0}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:800}
    .pill b{color:#b45309}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}
	/* é ­çé«˜äº®ï¼ˆsummaryï¼‰ */
details.prize-top > summary{
  background: #fff7ed;
  border: 1px solid #fdba74;
  border-radius: 10px;
  padding: 10px 12px;
  list-style: none;
}
details.prize-top > summary::-webkit-details-marker{ display:none; }
details.prize-top > summary::before{
  content: "ğŸ† ";
}

/* é ­çå±•é–‹å…§å®¹ä¹Ÿé«˜äº® */
details.prize-top table{
  border: 1px solid #fdba74;
  border-radius: 10px;
  overflow: hidden;
}
.ball{
  width:54px;height:54px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;font-weight:900;
  border:1px solid #e5e7eb;
  background:#fff;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
}

.ball.spin{
  animation: pop .35s ease-in-out infinite alternate;
}
.drawWrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.drawBalls{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  width:100%;
}
.drawLabel{ font-weight:900; text-align:center; }
.drawSep{ font-weight:900; opacity:.7; }

/* ç‰¹åˆ¥è™Ÿçƒï¼šä¸åŒé¡è‰² */
.ball.special{
  background: #fee2e2;
  border-color: rgba(185,28,28,.35);
  color: #b91c1c;
}

/* â‘¢ çµæœåˆ—è¡¨ æ¨™é¡Œç½®ä¸­ï¼ˆä½ ä¹Ÿå¯ä»¥åªç”¨ inline style æ”¹ h3ï¼‰ */
#resultStage > h3{ text-align:center; }
@keyframes pop{
  from{ transform: translateY(0) scale(1); }
  to  { transform: translateY(-6px) scale(1.05); }
}

.fade-in{
  opacity:0;
  transform: translateY(6px);
  transition: opacity .35s ease, transform .35s ease;
}
.fade-in.show{
  opacity:1;
  transform: translateY(0);
}
.manual-draw {
  display: none;
}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>è½‰ç›¤å¤§æ¨‚é€ï½œç®¡ç†è€…é–‹çé </h1>
    <div class="muted">
      ä½¿ç”¨æ–¹å¼ï¼šè¼‰å…¥åå–®ï¼ˆå¾ Google Sheetï¼‰â†’ è¼¸å…¥/è²¼ä¸Šä¸­çè™Ÿç¢¼ â†’ ç«‹å³ç®—ç â†’ åŒ¯å‡ºä¸­çåå–® CSVã€‚<br/>
      è¦å‰‡ï¼šä¸‰ç¢¼å‘½ä¸­ã€Œä¸çœ‹é †åºã€ï¼›ç‰¹åˆ¥è™Ÿç¨ç«‹ 1~7ï¼ˆå¯èˆ‡ä¸‰ç¢¼é‡è¤‡ï¼‰ã€‚
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin:0 0 10px 0">â‘  è¼‰å…¥åå–®</h3>
        <div class="btns">
          <button class="ghost" id="load">è¼‰å…¥åå–®ï¼ˆGETï¼‰</button>
          <button class="warn" id="clearCache">æ¸…ç©ºå¿«å–</button>
        </div>
        <div id="loadMsg" class="msg"></div>
        <div class="muted" id="countInfo">å°šæœªè¼‰å…¥ã€‚</div>
      </div>

      <div class="card">
        <div class="manual-draw">
    <h3 style="margin:0 0 10px 0">â‘¡ è¼¸å…¥ä¸­çè™Ÿç¢¼</h3>
    <div class="row">
      <label>é–‹çä¸‰ç¢¼</label>
      <input id="d3" placeholder="ä¾‹å¦‚ï¼š1 2 3ï¼ˆç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ†éš”ï¼‰" />
    </div>
    <div class="row">
      <label>ç‰¹åˆ¥è™Ÿ</label>
      <input id="ds" placeholder="ä¾‹å¦‚ï¼š5" />
    </div>
    <button class="primary" id="calc">ğŸ¬ é–‹ç</button>
  </div>
  <button class="ghost" id="draw">ğŸ² éš¨æ©Ÿé–‹ç</button>
  <button class="ghost" id="export">åŒ¯å‡ºä¸­çCSV</button>
</div>
        <div id="calcMsg" class="msg"></div>
        <div class="muted" id="summary">å°šæœªç®—çã€‚</div>
      </div>
    </div>
	
<div id="drawStage" style="display:none;margin:12px 0 16px 0">
  <div class="drawWrap">
    <div class="drawBalls">
      <div class="ball" id="ball1">?</div>
      <div class="ball" id="ball2">?</div>
      <div class="ball" id="ball3">?</div>

      <div class="drawSep">+</div>

      <div class="ball special" id="ballS">?</div>
    </div>

    <div id="drawLabel" class="drawLabel">é–‹çä¸­â€¦</div>
  </div>
</div>


    <div id="resultStage" class="fade-in">
      <h3 style="margin:0 0 10px 0">â‘¢ çµæœåˆ—è¡¨</h3>
      <div style="max-height:55vh;overflow:auto;border:1px solid var(--line);border-radius:14px">
        <table>
          <thead>
            <tr>
              <th style="width:52px">#</th>
              <th>å§“å</th>
              <th>ä¸‹æ³¨</th>
              <th>ä¸­ç</th>
              <th>çé‡‘</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="muted">å°šæœªç®—çã€‚</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="muted">
      çé …ï¼šé ­ç 3000ï¼ˆç‰¹åˆ¥+ä¸­ä¸‰ç¢¼ï¼‰/ è²³ç 1000ï¼ˆç‰¹åˆ¥+ä¸­å…©ç¢¼ï¼‰/ åƒç 500ï¼ˆç‰¹åˆ¥+ä¸­ä¸€ç¢¼ï¼‰/ è‚†ç 300ï¼ˆä¸­ä¸‰ç¢¼ï¼‰/ ä¼ç 200ï¼ˆä¸­å…©ç¢¼ï¼‰/ æ™®ç 100ï¼ˆä¸­ä¸€ç¢¼ï¼‰
    </div>
  </div>

  <script>
    // ====== ä½ ä¹Ÿå¯ä»¥åœ¨é€™è£¡å¯«æ­» URLï¼ˆå¯é¸ï¼‰======
    const API_URL = "https://script.google.com/macros/s/AKfycbxpP0wxOEAohT4dmA2klXJliOOLcxIWB2BbSXsBD3K5rBp8mEOA2GGBfN_ojJZhD7MZeQ/exec";
    // ============================================
    const $ = s => document.querySelector(s);
    const loadMsgEl = $("#loadMsg");
    const calcMsgEl = $("#calcMsg");
    const countInfoEl = $("#countInfo");
    const summaryEl = $("#summary");
    const tbodyEl = $("#tbody");

    let entries = [];        // å…¨éƒ¨åå–®
    let winners = [];        // ä¸­çåå–®ï¼ˆç®—çå¾Œï¼‰

    function showMsg(el, type, text){
      el.className = "msg " + (type === "ok" ? "ok" : "bad");
      el.textContent = text;
    }
    function clearMsg(el){ el.className = "msg"; el.textContent=""; }

    function parseNums(str){
      // å–å‡º 1~7 çš„æ•¸å­—
      const arr = (str.match(/[1-7]/g) || []).map(x => Number(x));
      return arr;
    }

    function readDrawInputs(){
  		const d3 = parseNums($("#d3").value).slice(0,3);
  		const dsArr = parseNums($("#ds").value);
  		const ds = dsArr[0];
  		return { d3, ds };
	}

    function valid1to8(n){ return Number.isInteger(n) && n>=1 && n<=8; }
	
	function randomUnique3(){
  const arr = [1,2,3,4,5,6,7,8];
  // æ´—ç‰Œå–å‰ä¸‰
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0,3).sort((a,b)=>a-b);
}

function setDrawInputs(d3, ds){
  $("#d3").value = d3.join(" ");
  $("#ds").value = String(ds);
}

    function calcPrize(entry, draw3, drawS){
      const pickSet = new Set(entry.pick3);
      let hit = 0;
      for(const n of draw3) if(pickSet.has(n)) hit++;
      const specialHit = entry.special === drawS;

      if(specialHit && hit===3) return {name:"æ¨‚é€é ­ç", amount:3000, key:"A"};
      if(specialHit && hit===2) return {name:"æ¨‚é€è²³ç", amount:1000, key:"B"};
      if(specialHit && hit===1) return {name:"æ¨‚é€åƒç", amount:500,  key:"C"};
      if(!specialHit && hit===3) return {name:"æ¨‚é€è‚†ç", amount:300,  key:"D"};
      if(!specialHit && hit===2) return {name:"æ¨‚é€ä¼ç", amount:200,  key:"E"};
      if(!specialHit && hit===1) return {name:"æ¨‚é€æ™®ç", amount:100,  key:"F"};
      return null;
    }
function playDrawAnimationAndRender(finalNums, finalSpecial){
  // finalNums: [n1,n2,n3] æœ€çµ‚é–‹çä¸‰ç¢¼
  const stage = document.getElementById('drawStage');
  const rstage = document.getElementById('resultStage');
  const b1 = document.getElementById('ball1');
  const b2 = document.getElementById('ball2');
  const b3 = document.getElementById('ball3');
  const bs = document.getElementById('ballS');
  const label = document.getElementById('drawLabel');

  // é¡¯ç¤ºå‹•ç•«ã€å…ˆæŠŠçµæœæ·¡å‡º
  if(stage) stage.style.display = '';
  if(label) label.textContent = 'é–‹çä¸­â€¦';
  if(rstage){ rstage.classList.remove('show'); }

  const balls = [b1,b2,b3,bs].filter(Boolean);
  balls.forEach(b => b.classList.add('spin'));

  const tick = () => String(1 + Math.floor(Math.random()*7));
  const timer = setInterval(()=>{
    if(b1) b1.textContent = tick();
    if(b2) b2.textContent = tick();
    if(b3) b3.textContent = tick();
    if(bs) bs.textContent = tick();
  }, 80);

  // ä¾åºåœçƒï¼ˆæ›´æœ‰ã€Œé–‹çæ„Ÿã€ï¼‰
  setTimeout(()=>{ if(b1){ b1.textContent = String(finalNums[0]); b1.classList.remove('spin'); } }, 900);
  setTimeout(()=>{ if(b2){ b2.textContent = String(finalNums[1]); b2.classList.remove('spin'); } }, 1500);
  setTimeout(()=>{ if(b3){ b3.textContent = String(finalNums[2]); b3.classList.remove('spin'); } }, 2100);
  setTimeout(()=>{ if(bs){ bs.textContent = String(finalSpecial); bs.classList.remove('spin'); } }, 2550);

  // æœ€å¾Œåœæ­¢ timerã€æ¸²æŸ“çµæœã€æ·¡å…¥ï¼ˆâš ï¸ä¸å†éš±è— stageï¼Œè®“çµæœç•™åœ¨é é¢ï¼‰
  setTimeout(()=>{
    clearInterval(timer);

    if(label) label.textContent = 'é–‹ççµæœ';

    renderResults();

    if(rstage){
      requestAnimationFrame(()=> rstage.classList.add('show'));
    }
  }, 2850);
}


function renderResults(){
  if(!winners.length){
    tbodyEl.innerHTML = `<tr><td colspan="6" class="muted">æœ¬æ¬¡ç„¡äººä¸­çã€‚</td></tr>`;
    return;
  }

  // ä¾çé …åˆ†çµ„
  const groups = {};
  for(const w of winners){
    if(!groups[w.prize]) groups[w.prize] = [];
    groups[w.prize].push(w);
  }

  // çé …é¡¯ç¤ºé †åº
  const prizeOrder = [
    "æ¨‚é€é ­ç",
    "æ¨‚é€è²³ç",
    "æ¨‚é€åƒç",
    "æ¨‚é€è‚†ç",
    "æ¨‚é€ä¼ç",
    "æ¨‚é€æ™®ç"
  ];

  // æ¸…ç©ºåŸæœ¬ table
  tbodyEl.innerHTML = `
    <tr>
      <td colspan="6" style="padding:0">
        ${prizeOrder.map(prize => {
          const list = groups[prize];
          if(!list || list.length === 0) return "";

          const isTop = (prize === prizeOrder[0]); // prizeOrder[0] = é ­çé‚£å€‹å­—ä¸²
return `
  <details class="${isTop ? 'prize-top' : ''}" style="border-bottom:1px solid #e5e7eb;padding:10px">
    <summary style="cursor:pointer;font-weight:900">
      ${prize}ï¼ˆ${list.length} äººï½œ$${list[0].amount.toLocaleString()}ï¼‰
    </summary>

              <table style="width:100%;margin-top:8px;font-size:14px">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>å§“å</th>
                    <th>ä¸‹æ³¨</th>
                    <th>çé‡‘</th>
                    <th>æ™‚é–“</th>
                  </tr>
                </thead>
                <tbody>
                  ${list.map((w,i)=>`
                    <tr>
                      <td>${i+1}</td>
                      <td><strong>${escapeHtml(w.name)}</strong></td>
                      <td>
                        ä¸‰ç¢¼ ${w.pick3.join(" ")} ï½œ ç‰¹ ${w.special}
                      </td>
                      <td><strong>NTD ${w.amount.toLocaleString()}</strong></td>
                      <td class="muted">${escapeHtml(w.time || "")}</td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </details>
          `;
        }).join("")}
      </td>
    </tr>
  `;
}


    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    async function loadEntries(){
      clearMsg(loadMsgEl);
      const url = API_URL;
      if(!url){ showMsg(loadMsgEl, "bad", "è«‹å…ˆè²¼ä¸Š Apps Script Web App URL"); return; }

      try{
        const res = await fetch(
			url + "?t=" + Date.now(),
			{
				method: "GET",
				cache: "no-store"
			}
		);
        const json = await res.json();

        if(!Array.isArray(json)){
          showMsg(loadMsgEl, "bad", "è¼‰å…¥å¤±æ•—ï¼šAPI å›å‚³ä¸æ˜¯é™£åˆ—ï¼ˆè«‹ç¢ºèª doGet å› JSON arrayï¼‰");
          return;
        }
        entries = json.map(r => ({
          time: r.time,
          name: r.name,
          pick3: (r.pick3 || []).map(Number),
          special: Number(r.special)
        })).filter(r => r.name && r.pick3.length === 3 && valid1to7(r.special));

        showMsg(loadMsgEl, "ok", "è¼‰å…¥æˆåŠŸ");
        countInfoEl.textContent = `å·²è¼‰å…¥ ${entries.length} ç­†åå–®ã€‚`;
      }catch(e){
        showMsg(loadMsgEl, "bad", "è¼‰å…¥å¤±æ•—ï¼ˆç¶²è·¯/æ¬Šé™/CORSï¼‰ï¼š"+ e);
      }
    }

    function runCalc(withAnimation = true){
      clearMsg(calcMsgEl);
      if(!entries.length){
        showMsg(calcMsgEl, "bad", "è«‹å…ˆè¼‰å…¥åå–®ï¼ˆå¾ Sheetï¼‰");
        return;
      }
      const {d3, ds} = readDrawInputs();
      if(d3.length !== 3 || d3.some(n=>!valid1to7(n))){
        showMsg(calcMsgEl, "bad", "é–‹çä¸‰ç¢¼è«‹è¼¸å…¥ 3 å€‹ 1~7 çš„æ•¸å­—");
        return;
      }
      // ä¸€èˆ¬é–‹çä¸‰ç¢¼ä¸é‡è¤‡ï¼›è‹¥ä½ è¦å…è¨±é‡è¤‡ï¼ŒæŠŠé€™æ®µåˆªæ‰å³å¯
      if(new Set(d3).size !== 3){
        showMsg(calcMsgEl, "bad", "é–‹çä¸‰ç¢¼è«‹å‹¿é‡è¤‡ï¼ˆè‹¥ä½ è¦å…è¨±é‡è¤‡æˆ‘ä¹Ÿå¯ä»¥å¹«ä½ æ”¹ï¼‰");
        return;
      }
      if(!valid1to7(ds)){
        showMsg(calcMsgEl, "bad", "ç‰¹åˆ¥è™Ÿè«‹è¼¸å…¥ 1~7");
        return;
      }

      const counts = {};
      let total = 0;
      winners = [];

      for(const e of entries){
        const p = calcPrize(e, d3, ds);
        if(p){
          counts[p.key] = (counts[p.key]||0)+1;
          total += p.amount;
          winners.push({
            time: e.time,
            name: e.name,
            pick3: e.pick3,
            special: e.special,
            prize: p.name,
            amount: p.amount
          });
        }
      }

      const winnersCount = winners.length;
      summaryEl.innerHTML = `
        <div style="font-weight:900;margin-bottom:6px">é–‹çï¼šä¸‰ç¢¼ ${d3.join(" ")}ï½œç‰¹åˆ¥è™Ÿ ${ds}</div>
        <div>ä¸­çäººæ•¸ï¼š<b>${winnersCount}</b> äººï½œç¸½ç™¼æ”¾ï¼š<b>NTD ${total.toLocaleString()}</b></div>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:6px">
          <div>é ­ç(3000)ï¼š${counts.A||0}</div>
          <div>è²³ç(1000)ï¼š${counts.B||0}</div>
          <div>åƒç(500)ï¼š${counts.C||0}</div>
          <div>è‚†ç(300)ï¼š${counts.D||0}</div>
          <div>ä¼ç(200)ï¼š${counts.E||0}</div>
          <div>æ™®ç(100)ï¼š${counts.F||0}</div>
        </div>
      `;

      showMsg(calcMsgEl, "ok", "ç®—çå®Œæˆ");
      if(withAnimation){
    playDrawAnimationAndRender(d3, ds);
  } else {
    renderResults();
  }
    }

    function exportWinners(){
      if(!winners.length){
        alert("ç›®å‰æ²’æœ‰ä¸­çåå–®å¯åŒ¯å‡º");
        return;
      }
      const header = ["time","name","pick1","pick2","pick3","special","prize","amount"];
      const rows = winners.map(w => [
        w.time ?? "",
        w.name ?? "",
        w.pick3?.[0] ?? "",
        w.pick3?.[1] ?? "",
        w.pick3?.[2] ?? "",
        w.special ?? "",
        w.prize ?? "",
        w.amount ?? ""
      ]);
      const csv = [header, ...rows]
        .map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "winners.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("#load").addEventListener("click", loadEntries);
    $("#calc").addEventListener("click", ()=> runCalc(true));
	$("#draw").addEventListener("click", ()=>{
  // éš¨æ©Ÿç”¢ç”Ÿä¸‰ç¢¼ï¼ˆä¸é‡è¤‡ï¼‰+ ç‰¹åˆ¥è™Ÿï¼ˆå¯é‡è¤‡ï¼‰
  const d3 = randomUnique3();
  const ds = 1 + Math.floor(Math.random()*8);
  setDrawInputs(d3, ds);
  runCalc(true); // ç›´æ¥è·‘å‹•ç•« + ä¸­çåå–®
});
    $("#export").addEventListener("click", exportWinners);
    $("#clearCache").addEventListener("click", ()=>{
      entries = [];
      winners = [];
      clearMsg(loadMsgEl); clearMsg(calcMsgEl);
      countInfoEl.textContent = "å·²æ¸…ç©ºå¿«å–ã€‚";
      summaryEl.textContent = "å°šæœªç®—çã€‚";
      tbodyEl.innerHTML = `<tr><td colspan="6" class="muted">å°šæœªç®—çã€‚</td></tr>`;
    });
  </script>
</body>
</html>




